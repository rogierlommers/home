<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Bookmarks</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" />
    <link rel="stylesheet" href="https://milligram.io/styles/main.css" />
    <style>
        .edit-table {
            width: 100%;
            margin: 0;
            table-layout: auto;
            border-collapse: collapse;
            max-width: none;
            min-width: 0;
        }

        .edit-table input[type="text"],
        .edit-table input[type="url"] {
            width: 140px;
            min-width: 60px;
            font-size: 0.85em;
            padding: 4px 6px;
        }

        .edit-table select.edit-category {
            width: 100px;
            min-width: 80px;
            font-size: 0.85em;
            padding: 4px 6px;
        }

        .edit-table th,
        .edit-table td {
            vertical-align: middle;
            padding: 0.2em 0.3em;
            border: none !important;
            white-space: nowrap;
        }

        .edit-table input[type="checkbox"] {
            transform: scale(1.2);
        }

        .edit-table button {
            margin: 0 1px;
            padding: 2px 6px;
            min-width: unset;
            width: auto;
            font-size: 0.7em;
            line-height: 1.2;
            white-space: nowrap;
        }

        .action-buttons {
            display: flex;
            gap: 2px;
            flex-wrap: nowrap;
        }

        #editBookmarksTable {
            width: 100%;
            max-width: none;
            margin: 0;
            overflow-x: auto;
        }

        /* Make form more compact */
        #addBookmarkForm input,
        #addBookmarkForm select {
            font-size: 0.9em;
            padding: 6px 8px;
        }

        #addBookmarkForm label {
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        #addBookmarkForm .button {
            padding: 6px 12px;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <main class="wrapper">
        <section class="container" id="examples">
            <h1 class="title">home service</h1>

            <!-- Navigation Links -->
            <h4><a href="/bookmarks">bookmarks</a> (<a href="/bookmarks/edit">#</a>) / <a
                    href="/statistics">statistics</a> /
                <a href="notify">notify</a> / <a href="storage">storage</a> / <a href="/events">events</a>
            </h4>

            <!-- Add bookmark form-->
            <h4 style="margin-top: 2em;">Add New Bookmark</h4>
            <form id="addBookmarkForm" style="margin-bottom:2em;">
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;">
                    <div style="flex:1; min-width:150px;">
                        <label for="bmTitle">Title</label>
                        <input type="text" id="bmTitle" name="title" required />
                    </div>
                    <div style="flex:1; min-width:150px;">
                        <label for="bmArg">URL</label>
                        <input type="url" id="bmArg" name="arg" required />
                    </div>
                    <div style="flex:0 0 auto; min-width:120px;">
                        <label for="bmCategory">Category</label>
                        <select id="bmCategory" name="category" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div style="flex:0 0 auto;">
                        <button type="submit" class="button">Add</button>
                    </div>
                </div>
            </form>
            <div id="addBookmarkStatus" style="margin-bottom:1em;"></div>

            <div id="editBookmarksTable">Loading bookmarks...</div>

        </section>
    </main>
    <script>
        let allBookmarks = []; // Store all bookmarks for reordering

        // Fetch and render all bookmarks in an editable table
        function loadEditBookmarks() {
            fetch('/api/bookmarks')
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(data => {
                    allBookmarks = data.items || [];
                    renderEditBookmarksTable(allBookmarks);
                })
                .catch(() => {
                    document.getElementById('editBookmarksTable').textContent = 'Failed to load bookmarks.';
                });
        }

        function renderEditBookmarksTable(items) {
            if (!items || !items.length) {
                document.getElementById('editBookmarksTable').textContent = 'No bookmarks found.';
                return;
            }

            // Group items by category ID and sort by category ID
            const categoryMap = new Map();
            items.forEach(item => {
                if (!categoryMap.has(item.category_id)) {
                    categoryMap.set(item.category_id, []);
                }
                categoryMap.get(item.category_id).push(item);
            });

            // Sort categories by ID
            const sortedCategories = Array.from(categoryMap.keys()).sort((a, b) => a - b);

            // Sort items within each category by priority (higher first)
            sortedCategories.forEach(categoryId => {
                categoryMap.get(categoryId).sort((a, b) => (b.priority || 0) - (a.priority || 0));
            });

            let html = '';
            let globalIndex = 0;

            sortedCategories.forEach(categoryId => {
                const categoryItems = categoryMap.get(categoryId);
                const categoryName = categoryIdToName[categoryId] || `Category ${categoryId}`;

                html += `<h3 style="margin-top: 1.5em; margin-bottom: 0.5em; color: #606c76;">${categoryName}</h3>`;
                html += `<table class="edit-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Priority</th>
                            <th>Title</th>
                            <th>URL</th>
                            <th>Category</th>
                            <th>Hide</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                categoryItems.forEach((item, localIndex) => {
                    // Create category dropdown options
                    let categoryOptions = '';
                    Object.entries(categoryIdToName).forEach(([id, name]) => {
                        const selected = item.category_id == id ? 'selected' : '';
                        categoryOptions += `<option value="${id}" ${selected}>${name}</option>`;
                    });

                    html += `
                        <tr data-id="${item.id}" data-index="${globalIndex}">
                            <td>${item.id}</td>
                            <td><input type="number" value="${item.priority || 0}" class="edit-priority" style="width: 60px;" /></td>
                            <td><input type="text" value="${item.title || ''}" class="edit-title" /></td>
                            <td><input type="url" value="${item.arg || ''}" class="edit-arg" /></td>
                            <td>
                                <select class="edit-category">
                                    ${categoryOptions}
                                </select>
                            </td>
                            <td style="text-align:center;">
                                <input type="checkbox" class="edit-hide" ${item.hide_in_gui ? 'checked' : ''} />
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="button button-outline save-btn" type="button">Save</button>
                                    <button class="button button-outline delete-btn" type="button" style="color:#d9534f;">Del</button>
                                    <span class="row-status" style="margin-left: 8px; font-size: 0.85em;"></span>
                                </div>
                            </td>
                        </tr>
                    `;
                    globalIndex++;
                });
                html += '</tbody></table>';
            });
            document.getElementById('editBookmarksTable').innerHTML = html;

            // Add event listeners for Save and Delete
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.onclick = function () {
                    const row = btn.closest('tr');
                    saveBookmarkRow(row);
                };
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = function () {
                    const row = btn.closest('tr');
                    const id = row.getAttribute('data-id');
                    const statusSpan = row.querySelector('.row-status');
                    if (confirm('Are you sure you want to delete this bookmark?')) {
                        fetch(`/api/bookmarks/${id}`, {
                            method: 'DELETE'
                        })
                            .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                            .then(() => {
                                statusSpan.textContent = 'Deleted!';
                                statusSpan.style.color = 'green';
                                loadEditBookmarks();
                            })
                            .catch(() => {
                                statusSpan.textContent = 'Failed to delete';
                                statusSpan.style.color = 'red';
                            });
                    }
                };
            });
        }

        function saveBookmarkRow(row) {
            const id = row.getAttribute('data-id');
            const title = row.querySelector('.edit-title').value;
            const arg = row.querySelector('.edit-arg').value;
            const category_id = parseInt(row.querySelector('.edit-category').value, 10);
            const hide_in_gui = row.querySelector('.edit-hide').checked;
            const priority = parseInt(row.querySelector('.edit-priority').value, 10) || 0;
            const statusSpan = row.querySelector('.row-status');

            console.log("Updating bookmark:", { id, title, arg, category_id, hide_in_gui, priority });
            fetch(`/api/bookmarks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    arg,
                    category_id,
                    hide_in_gui,
                    priority
                })
            })
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(() => {
                    statusSpan.textContent = 'Saved!';
                    statusSpan.style.color = 'green';
                })
                .catch(() => {
                    statusSpan.textContent = 'Failed to update';
                    statusSpan.style.color = 'red';
                });
        }

        // Add bookmark functionality
        let categoryIdToName = {};

        function loadCategoriesDropdown() {
            fetch('/api/categories')
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(data => {
                    console.log("Categories API response:", data);
                    const select = document.getElementById('bmCategory');
                    select.innerHTML = '';
                    categoryIdToName = {};

                    const categories = Array.isArray(data) ? data : (data.items || data.categories || []);

                    if (categories.length > 0) {
                        categories.forEach(cat => {
                            categoryIdToName[cat.id] = cat.name;
                            const opt = document.createElement('option');
                            opt.value = cat.id;
                            opt.textContent = cat.name;
                            select.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'No categories found';
                        select.appendChild(opt);
                    }
                })
                .catch(error => {
                    console.error("Failed to load categories:", error);
                    const select = document.getElementById('bmCategory');
                    select.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Failed to load categories';
                    select.appendChild(opt);
                });
        }

        // Handle add bookmark form submission
        document.getElementById('addBookmarkForm').onsubmit = function (e) {
            e.preventDefault();
            const title = this.title.value.trim();
            const arg = this.arg.value.trim();
            const category_id = this.category.value;
            if (!title || !arg || !category_id) {
                return;
            }
            fetch('/api/bookmarks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    arg,
                    category_id: parseInt(category_id, 10),
                    hide_in_gui: false
                })
            })
                .then(res => {
                    if (res.ok) return res.json();
                    // Try to get error details from the response
                    return res.text().then(text => {
                        throw { status: res.status, statusText: res.statusText, body: text };
                    });
                })
                .then(data => {
                    document.getElementById('addBookmarkStatus').textContent = 'Bookmark added!';
                    document.getElementById('addBookmarkStatus').style.color = 'green';
                    this.reset();
                    loadCategoriesDropdown();
                    loadEditBookmarks();
                })
                .catch((err) => {
                    let msg = 'Failed to add bookmark.';
                    if (err && err.body) {
                        msg += ' ' + err.body;
                    } else if (err && err.statusText) {
                        msg += ' ' + err.statusText;
                    }
                    document.getElementById('addBookmarkStatus').textContent = msg;
                    document.getElementById('addBookmarkStatus').style.color = 'red';
                    console.error('Failed to add bookmark:', err);
                });
        };

        // Initial load
        loadCategoriesDropdown();
        setTimeout(() => {
            loadEditBookmarks();
        }, 100);
    </script>
</body>

</html>