<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Bookmarks</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" />
    <link rel="stylesheet" href="https://milligram.io/styles/main.css" />
    <style>
        .edit-table {
            width: auto;
            margin: 0 auto;
            table-layout: auto;
            border-collapse: collapse;
            max-width: none;
            min-width: 0;
        }

        .edit-table input[type="text"],
        .edit-table input[type="url"] {
            width: 140px;
            min-width: 60px;
            font-size: 0.85em;
            padding: 4px 6px;
        }

        .edit-table select.edit-category {
            width: 100px;
            min-width: 80px;
            font-size: 0.85em;
            padding: 4px 6px;
        }

        .edit-table th,
        .edit-table td {
            vertical-align: middle;
            padding: 0.2em 0.3em;
            border: none !important;
            white-space: nowrap;
        }

        .edit-table input[type="checkbox"] {
            transform: scale(1.2);
        }

        .edit-table button {
            margin: 0 1px;
            padding: 2px 6px;
            min-width: unset;
            width: auto;
            font-size: 0.7em;
            line-height: 1.2;
            white-space: nowrap;
        }

        .priority-arrows {
            display: flex;
            flex-direction: row;
            gap: 2px;
        }

        .priority-arrows button {
            padding: 2px 6px;
            font-size: 0.75em;
            line-height: 1;
            min-width: 24px;
            margin: 0;
        }

        .action-buttons {
            display: flex;
            gap: 2px;
            flex-wrap: nowrap;
        }

        #editBookmarksTable {
            width: auto;
            max-width: none;
            margin: 0 auto;
            overflow-x: auto;
        }

        /* Make form more compact */
        #addBookmarkForm input,
        #addBookmarkForm select {
            font-size: 0.9em;
            padding: 6px 8px;
        }

        #addBookmarkForm label {
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        #addBookmarkForm .button {
            padding: 6px 12px;
            font-size: 0.85em;
        }
    </style>
</head>

<body>
    <main class="wrapper">
        <section class="container" id="examples">
            <h1 class="title">home service</h1>

            <!-- Navigation Links -->
            <h4><a href="/bookmarks">bookmarks</a> (<a href="/bookmarks/edit">#</a>) / <a
                    href="/statistics">statistics</a> /
                <a href="/notify">notify</a> / <a href="/storage">storage</a>
            </h4>

            <!-- Add bookmark form-->
            <h4 style="margin-top: 2em;">Add New Bookmark</h4>
            <form id="addBookmarkForm" style="margin-bottom:2em;">
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;">
                    <div style="flex:1; min-width:150px;">
                        <label for="bmTitle">Title</label>
                        <input type="text" id="bmTitle" name="title" required />
                    </div>
                    <div style="flex:1; min-width:150px;">
                        <label for="bmArg">URL</label>
                        <input type="url" id="bmArg" name="arg" required />
                    </div>
                    <div style="flex:0 0 auto; min-width:120px;">
                        <label for="bmCategory">Category</label>
                        <select id="bmCategory" name="category" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div style="flex:0 0 auto;">
                        <button type="submit" class="button">Add</button>
                    </div>
                </div>
                <span id="addBookmarkStatus" style="margin-top:8px; display:inline-block;"></span>
            </form>

            <h4 style="margin-top: 2em;">Existing bookmarks</h4>
            <div id="editBookmarksStatus" style="margin-bottom:1em;"></div>
            <div id="editBookmarksTable">Loading bookmarks...</div>

        </section>
    </main>
    <script>
        let allBookmarks = []; // Store all bookmarks for reordering

        // Fetch and render all bookmarks in an editable table
        function loadEditBookmarks() {
            fetch('/api/bookmarks')
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(data => {
                    allBookmarks = data.items || [];
                    renderEditBookmarksTable(allBookmarks);
                })
                .catch(() => {
                    document.getElementById('editBookmarksTable').textContent = 'Failed to load bookmarks.';
                });
        }

        function renderEditBookmarksTable(items) {
            if (!items || !items.length) {
                document.getElementById('editBookmarksTable').textContent = 'No bookmarks found.';
                return;
            }
            let html = `<table class="edit-table">
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Title</th>
                        <th>URL</th>
                        <th>Category</th>
                        <th>Hide</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            items.forEach((item, index) => {
                // Create category dropdown options
                let categoryOptions = '';
                Object.entries(categoryIdToName).forEach(([id, name]) => {
                    const selected = item.category_id == id ? 'selected' : '';
                    categoryOptions += `<option value="${id}" ${selected}>${name}</option>`;
                });

                html += `
                    <tr data-id="${item.id}" data-index="${index}">
                        <td>
                            <div class="priority-arrows">
                                <button class="button button-outline move-up-btn" type="button" ${index === 0 ? 'disabled' : ''}>↑</button>
                                <button class="button button-outline move-down-btn" type="button" ${index === items.length - 1 ? 'disabled' : ''}>↓</button>
                            </div>
                        </td>
                        <td><input type="text" value="${item.title || ''}" class="edit-title" /></td>
                        <td><input type="url" value="${item.arg || ''}" class="edit-arg" /></td>
                        <td>
                            <select class="edit-category">
                                ${categoryOptions}
                            </select>
                        </td>
                        <td style="text-align:center;">
                            <input type="checkbox" class="edit-hide" ${item.hide_in_gui ? 'checked' : ''} />
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="button button-outline save-btn" type="button">Save</button>
                                <button class="button button-outline delete-btn" type="button" style="color:#d9534f;">Del</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            document.getElementById('editBookmarksTable').innerHTML = html;

            // Add event listeners for Priority arrows
            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.onclick = function () {
                    const row = btn.closest('tr');
                    const index = parseInt(row.getAttribute('data-index'));
                    if (index > 0) {
                        moveBookmarkPriority(index, 'up');
                    }
                };
            });

            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.onclick = function () {
                    const row = btn.closest('tr');
                    const index = parseInt(row.getAttribute('data-index'));
                    if (index < allBookmarks.length - 1) {
                        moveBookmarkPriority(index, 'down');
                    }
                };
            });

            // Add event listeners for Save and Delete
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.onclick = function () {
                    const row = btn.closest('tr');
                    saveBookmarkRow(row);
                };
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = function () {
                    const row = btn.closest('tr');
                    const id = row.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this bookmark?')) {
                        fetch(`/api/bookmarks/${id}`, {
                            method: 'DELETE'
                        })
                            .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                            .then(() => {
                                document.getElementById('editBookmarksStatus').textContent = 'Bookmark deleted!';
                                document.getElementById('editBookmarksStatus').style.color = 'green';
                                loadEditBookmarks();
                            })
                            .catch(() => {
                                document.getElementById('editBookmarksStatus').textContent = 'Failed to delete bookmark.';
                                document.getElementById('editBookmarksStatus').style.color = 'red';
                            });
                    }
                };
            });
        }

        function moveBookmarkPriority(index, direction) {
            const bookmark = allBookmarks[index];
            const currentPriority = bookmark.priority || 0;
            const newPriority = direction === 'up' ? currentPriority + 1 : currentPriority - 1;

            // dump full request
            console.debug(`Changing priority of bookmark ID ${bookmark.id} from ${currentPriority} to ${newPriority}`);
            console.debug(bookmark)

            // Update the single bookmark with new priority
            fetch(`/api/bookmarks/${bookmark.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: bookmark.title,
                    arg: bookmark.arg,
                    category_id: bookmark.category_id,
                    hide_in_gui: bookmark.hide_in_gui,
                    priority: newPriority
                })
            })
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(() => {
                    document.getElementById('editBookmarksStatus').textContent = 'Priority updated!';
                    document.getElementById('editBookmarksStatus').style.color = 'green';
                    // Reload to get the updated order from the server
                    loadEditBookmarks();
                })
                .catch(() => {
                    document.getElementById('editBookmarksStatus').textContent = 'Failed to update priority.';
                    document.getElementById('editBookmarksStatus').style.color = 'red';
                });
        }

        function saveBookmarkRow(row) {
            const id = row.getAttribute('data-id');
            const title = row.querySelector('.edit-title').value;
            const arg = row.querySelector('.edit-arg').value;
            const category_id = parseInt(row.querySelector('.edit-category').value, 10);
            const hide_in_gui = row.querySelector('.edit-hide').checked;

            console.log("Updating bookmark:", { id, title, arg, category_id, hide_in_gui });
            fetch(`/api/bookmarks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    arg,
                    category_id,
                    hide_in_gui
                })
            })
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(() => {
                    document.getElementById('editBookmarksStatus').textContent = 'Bookmark updated!';
                    document.getElementById('editBookmarksStatus').style.color = 'green';
                    loadEditBookmarks();
                })
                .catch(() => {
                    document.getElementById('editBookmarksStatus').textContent = 'Failed to update bookmark.';
                    document.getElementById('editBookmarksStatus').style.color = 'red';
                });
        }

        // Add bookmark functionality
        let categoryIdToName = {};

        function loadCategoriesDropdown() {
            fetch('/api/categories')
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(data => {
                    console.log("Categories API response:", data);
                    const select = document.getElementById('bmCategory');
                    select.innerHTML = '';
                    categoryIdToName = {};
                    
                    const categories = Array.isArray(data) ? data : (data.items || data.categories || []);
                    
                    if (categories.length > 0) {
                        categories.forEach(cat => {
                            categoryIdToName[cat.id] = cat.name;
                            const opt = document.createElement('option');
                            opt.value = cat.id;
                            opt.textContent = cat.name;
                            select.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'No categories found';
                        select.appendChild(opt);
                    }
                })
                .catch(error => {
                    console.error("Failed to load categories:", error);
                    const select = document.getElementById('bmCategory');
                    select.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Failed to load categories';
                    select.appendChild(opt);
                });
        }

        // Handle add bookmark form submission
        document.getElementById('addBookmarkForm').onsubmit = function (e) {
            e.preventDefault();
            const title = this.title.value.trim();
            const arg = this.arg.value.trim();
            const category_id = this.category.value;
            if (!title || !arg || !category_id) {
                return;
            }
            fetch('/api/bookmarks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    arg,
                    category_id: parseInt(category_id, 10),
                    hide_in_gui: false
                })
            })
                .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
                .then(data => {
                    document.getElementById('addBookmarkStatus').textContent = 'Bookmark added!';
                    document.getElementById('addBookmarkStatus').style.color = 'green';
                    this.reset();
                    loadCategoriesDropdown();
                    loadEditBookmarks();
                })
                .catch(() => {
                    document.getElementById('addBookmarkStatus').textContent = 'Failed to add bookmark.';
                    document.getElementById('addBookmarkStatus').style.color = 'red';
                });
        };

        // Initial load
        loadCategoriesDropdown();
        setTimeout(() => {
            loadEditBookmarks();
        }, 100);
    </script>
</body>

</html>