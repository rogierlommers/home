<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>home service</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" />
    <link rel="stylesheet" href="https://milligram.io/styles/main.css" />
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #888;
            margin-top: 2em;
            transition: border-color 0.2s;
        }

        .drop-zone.dragover {
            border-color: #333;
            background: #f9f9f9;
            color: #333;
        }

        .drop-zone input {
            display: none;
        }

        #progressContainer {
            width: 100%;
            background: #eee;
            border-radius: 4px;
            margin: 1em 0;
            height: 18px;
            display: none;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: #9b4dca;
            border-radius: 4px;
            transition: width 0.2s;
        }

        .logout-btn {
            margin-bottom: 2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f4f4f4;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .filter-links a {
            margin-right: 15px;
            text-decoration: none;
        }

        .filter-links a.active {
            font-weight: bold;
            text-decoration: underline;
        }

        .filters-container {
            display: flex;
            gap: 40px;
            margin-top: 2em;
            flex-wrap: wrap;
        }

        .filter-section {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>

<body>
    <main class="wrapper">

        <section class="container" id="examples">
            <h1 class="title">home service</h1>

            <!-- Navigation Links -->
            <h4><a href="/bookmarks">bookmarks</a> (<a href="/bookmarks/edit">#</a>) / <a
                    href="/statistics">statistics</a> /
                <a href="notify">notify</a> / <a href="storage">storage</a> / <a href="/events">events</a>
            </h4>

            <div class="filters-container">
                <div class="filter-section">
                    <h4>Filter by Category</h4>
                    <div id="categoryFilterLinks" class="filter-links">
                        <p>Loading categories...</p>
                    </div>
                </div>

                <div class="filter-section">
                    <h4>Filter by Label</h4>
                    <div id="labelFilterLinks" class="filter-links">
                        <p>Loading labels...</p>
                    </div>
                </div>
            </div>

            <h4 style="margin-top: 2em;">Events</h4>
            <div id="eventsTableContainer">
                <p>Loading events...</p>
            </div>

        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const categoryLinksContainer = document.getElementById('categoryFilterLinks');
            const labelLinksContainer = document.getElementById('labelFilterLinks');
            const eventsContainer = document.getElementById('eventsTableContainer');

            // Track active filters
            let activeFilters = {
                category: '',
                label: ''
            };

            // Helper function to calculate relative time
            function timeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.round((now - date) / 1000);

                const intervals = [
                    { label: 'year', seconds: 31536000 },
                    { label: 'month', seconds: 2592000 },
                    { label: 'day', seconds: 86400 },
                    { label: 'hour', seconds: 3600 },
                    { label: 'minute', seconds: 60 },
                    { label: 'second', seconds: 1 }
                ];

                for (const interval of intervals) {
                    const count = Math.floor(seconds / interval.seconds);
                    if (count >= 1) {
                        return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
                    }
                }
                return 'just now';
            }

            // Function to fetch and display events
            function loadEvents() {
                const params = new URLSearchParams();
                if (activeFilters.category) {
                    params.append('category', activeFilters.category);
                }
                if (activeFilters.label) {
                    params.append('label', activeFilters.label);
                }

                eventsContainer.innerHTML = '<p>Loading events...</p>';
                fetch(`/api/events?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        return response.json();
                    })
                    .then(events => {
                        if (!events || events.length === 0) {
                            eventsContainer.innerHTML = '<p>No events found for the selected criteria.</p>';
                            return;
                        }

                        let tableHTML = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Source</th>
                                        <th>Label</th>
                                        <th>Message</th>
                                        <th>Category</th>
                                        <th>Added</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        events.forEach(event => {
                            tableHTML += `
                                <tr>
                                    <td>${event.id}</td>
                                    <td>${event.source || '-'}</td>
                                    <td>${event.label || '-'}</td>
                                    <td>${event.message || '-'}</td>
                                    <td>${event.category || '-'}</td>
                                    <td>${timeAgo(event.added)}</td>
                                </tr>
                            `;
                        });
                        tableHTML += '</tbody></table>';
                        eventsContainer.innerHTML = tableHTML;
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        eventsContainer.innerHTML = '<p style="color: red;">Error loading events.</p>';
                    });
            }

            // Function to fetch and display categories as links
            function loadCategories() {
                fetch('/api/events/categories')
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        return response.json();
                    })
                    .then(categories => {
                        if (!categories || categories.length === 0) {
                            categoryLinksContainer.innerHTML = '<p>No categories found.</p>';
                            return;
                        }

                        let linksHTML = '<a href="#" class="active" data-category="">All</a>';
                        categories.forEach(categoryName => {
                            linksHTML += `<a href="#" data-category="${categoryName}">${categoryName}</a>`;
                        });
                        categoryLinksContainer.innerHTML = linksHTML;
                    })
                    .catch(error => {
                        console.error('Error fetching categories:', error);
                        categoryLinksContainer.innerHTML = '<p style="color: red;">Error loading categories.</p>';
                    });
            }

            // Function to fetch and display labels as links
            function loadLabels() {
                fetch('/api/events/labels')
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        return response.json();
                    })
                    .then(labels => {
                        if (!labels || labels.length === 0) {
                            labelLinksContainer.innerHTML = '<p>No labels found.</p>';
                            return;
                        }

                        let linksHTML = '<a href="#" class="active" data-label="">All</a>';
                        labels.forEach(labelName => {
                            linksHTML += `<a href="#" data-label="${labelName}">${labelName}</a>`;
                        });
                        labelLinksContainer.innerHTML = linksHTML;
                    })
                    .catch(error => {
                        console.error('Error fetching labels:', error);
                        labelLinksContainer.innerHTML = '<p style="color: red;">Error loading labels.</p>';
                    });
            }

            // Handle clicks on category links
            categoryLinksContainer.addEventListener('click', function (e) {
                if (e.target.tagName === 'A') {
                    e.preventDefault();

                    // Update active class
                    categoryLinksContainer.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                    e.target.classList.add('active');

                    // Update active filter
                    activeFilters.category = e.target.dataset.category;
                    loadEvents();
                }
            });

            // Handle clicks on label links
            labelLinksContainer.addEventListener('click', function (e) {
                if (e.target.tagName === 'A') {
                    e.preventDefault();

                    // Update active class
                    labelLinksContainer.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                    e.target.classList.add('active');

                    // Update active filter
                    activeFilters.label = e.target.dataset.label;
                    loadEvents();
                }
            });

            // Initial load
            loadCategories();
            loadLabels();
            loadEvents();
        });
    </script>

</body>

</html>