<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>home service</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" />
  <link rel="stylesheet" href="https://milligram.io/styles/main.css" />
  <style>
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      color: #888;
      margin-top: 2em;
      transition: border-color 0.2s;
    }

    .drop-zone.dragover {
      border-color: #333;
      background: #f9f9f9;
      color: #333;
    }

    .drop-zone input {
      display: none;
    }

    #progressContainer {
      width: 100%;
      background: #eee;
      border-radius: 4px;
      margin: 1em 0;
      height: 18px;
      display: none;
    }

    #progressBar {
      height: 100%;
      width: 0%;
      background: #9b4dca;
      border-radius: 4px;
      transition: width 0.2s;
    }

    .logout-btn {
      margin-bottom: 2em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f4f4f4;
    }

    tr:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>

<body>
  <main class="wrapper">

    <section class="container" id="examples">
      <h1 class="title">home service</h1>
      <p>
        <em>Everything you need at home...</em>
      <ul>
        <li><a href="/api/greedy/rss">Greedy RSS</a></li>
        <li><a href="/api/logout">Logout</a></li>
      </ul>
      </p>

      <h4>Upload a file</h4>
      <form id="uploadForm" action="/api/upload" method="post" enctype="multipart/form-data">
        <div style="display: flex; align-items: flex-start; gap: 16px;">
          <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
            <label for="targetEmail">Target email address</label>
            <select id="targetEmail" name="targetEmail">
              <option value="private">Private</option>
              <option value="work">Work</option>
            </select>
            <label for="subject">Subject</label>
            <input type="text" id="subject" name="subject" placeholder="Enter subject..." />
            <label for="message">Description</label>
            <textarea id="message" name="message" placeholder="Enter message..." rows="4" style="resize:vertical;"></textarea>
          </div>
          <div style="flex: 0 0 220px; display: flex; flex-direction: column; align-items: stretch; gap: 8px;">
            <div class="drop-zone" id="dropZone" style="padding: 18px; min-height: 60px;">
              <span id="dropZoneText">Drag &amp; drop files<br>or click</span>
              <input type="file" name="file" id="fileInput" multiple />
            </div>
            <div id="fileListPreview" style="font-size: 0.95em; min-height: 24px; margin-top: 4px;"></div>
          </div>
        </div>
        <div id="progressContainer">
          <div id="progressBar"></div>
        </div>
        <div style="height: 24px;"></div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="submit" class="button">Upload</button>
          <label style="margin-bottom:0;">
            <input type="checkbox" id="onlyUploadCheckbox" name="onlyUpload" value="true" />
            Only upload files
          </label>
        </div>
      </form>
      <div id="uploadStatus"></div>
      <h4>File list</h4>
      <div id="fileList">
        Loading...
      </div>
    </section>

    <script>
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const dropZoneText = document.getElementById('dropZoneText');
      const uploadForm = document.getElementById('uploadForm');
      const uploadStatus = document.getElementById('uploadStatus');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const fileListPreview = document.getElementById('fileListPreview');

      function updateFileListPreview(files) {
        if (!files || files.length === 0) {
          fileListPreview.textContent = '';
          return;
        }
        const names = Array.from(files).map(f => f.name);
        fileListPreview.innerHTML = '<strong>Selected:</strong><br>' + names.join('<br>');
      }

      dropZone.addEventListener('click', () => fileInput.click());

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          updateFileListPreview(fileInput.files);
          if (fileInput.files.length === 1) {
            dropZoneText.textContent = fileInput.files[0].name;
          } else {
            dropZoneText.textContent = fileInput.files.length + " files selected";
          }
        }
      });

      fileInput.addEventListener('change', () => {
        updateFileListPreview(fileInput.files);
        if (fileInput.files.length) {
          if (fileInput.files.length === 1) {
            dropZoneText.textContent = fileInput.files[0].name;
          } else {
            dropZoneText.textContent = fileInput.files.length + " files selected";
          }
        } else {
          dropZoneText.textContent = 'Drag & drop files<br>or click';
        }
      });

      uploadForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(uploadForm);

        // Add checkbox value explicitly (in case unchecked, value won't be sent)
        formData.set('onlyUpload', document.getElementById('onlyUploadCheckbox').checked ? 'true' : 'false');

        // Add subject, message, and targetEmail values explicitly
        formData.set('subject', document.getElementById('subject').value);
        formData.set('message', document.getElementById('message').value);
        formData.set('targetEmail', document.getElementById('targetEmail').value);

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        uploadStatus.textContent = '';
        uploadStatus.style.color = ''; // Reset color
        uploadStatus.style.fontSize = ''; // Reset font size

        const xhr = new XMLHttpRequest();
        xhr.open('POST', uploadForm.action, true);

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            progressBar.style.width = percent + '%';
          }
        };

        xhr.onload = function () {
          progressBar.style.width = '100%';
          if (xhr.status >= 200 && xhr.status < 300) {
            uploadStatus.textContent = 'Upload successful!';
            uploadStatus.style.color = '';
            uploadStatus.style.fontSize = '';
            loadFileList(); // reload file list after successful upload
          } else {
            uploadStatus.textContent = 'Upload failed.';
            uploadStatus.style.color = 'red';
            uploadStatus.style.fontSize = '1.5em';
          }
          setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
          }, 1200);
        };

        xhr.onerror = function () {
          uploadStatus.textContent = 'Upload failed.';
          uploadStatus.style.color = 'red';
          uploadStatus.style.fontSize = '1.5em';
          progressContainer.style.display = 'none';
          progressBar.style.width = '0%';
        };

        xhr.send(formData);
      });

      // State for sorting
      let fileListData = [];
      let sortColumn = 'name';
      let sortAsc = true;

      // Fetch and display file list as a sortable table
      function loadFileList() {
        fetch('/api/filelist')
          .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
          .then(data => {
            fileListData = data.files || [];
            renderFileTable();
          })
          .catch(() => {
            document.getElementById('fileList').textContent = 'Failed to load file list.';
          });
      }

      function renderFileTable() {
        const fileListDiv = document.getElementById('fileList');
        if (!fileListData.length) {
          fileListDiv.textContent = 'No files found.';
          return;
        }

        // Sort data
        const sorted = [...fileListData].sort((a, b) => {
          let vA, vB;
          if (sortColumn === 'name') {
            vA = a.name.toLowerCase();
            vB = b.name.toLowerCase();
          } else if (sortColumn === 'size') {
            vA = a.size;
            vB = b.size;
          } else if (sortColumn === 'modTime') {
            vA = new Date(a.modTime);
            vB = new Date(b.modTime);
          }
          if (vA < vB) return sortAsc ? -1 : 1;
          if (vA > vB) return sortAsc ? 1 : -1;
          return 0;
        });

        // Table headers with sort indicators
        function th(label, col) {
          let arrow = '';
          if (sortColumn === col) arrow = sortAsc ? ' ▲' : ' ▼';
          return `<th style="cursor:pointer;" onclick="sortFileTable('${col}')">${label}${arrow}</th>`;
        }

        let table = `<table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              ${th('File', 'name')}
              ${th('Size', 'size')}
              ${th('Age', 'modTime')}
            </tr>
          </thead>
          <tbody>
        `;
        table += sorted.map(f => {
          // Format size in KB/MB
          let size = f.size;
          if (size > 1024 * 1024) {
            size = (size / (1024 * 1024)).toFixed(2) + ' MB';
          } else if (size > 1024) {
            size = (size / 1024).toFixed(2) + ' KB';
          } else {
            size = size + ' B';
          }
          // Calculate age
          const age = getFileAge(f.modTime);
          return `<tr>
            <td><a href="/api/download?filename=${encodeURIComponent(f.name)}" download>${f.name}</a></td>
            <td style="text-align:right;">${size}</td>
            <td style="text-align:right;">${age}</td>
          </tr>`;
        }).join('');
        table += '</tbody></table>';
        fileListDiv.innerHTML = table;
      }

      // Sorting handler
      window.sortFileTable = function(col) {
        if (sortColumn === col) {
          sortAsc = !sortAsc;
        } else {
          sortColumn = col;
          sortAsc = true;
        }
        renderFileTable();
      };

      // Helper to format file age from ISO string
      function getFileAge(modTime) {
        const mod = new Date(modTime);
        const now = new Date();
        const diffMs = now - mod;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHr = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHr / 24);

        if (diffDay > 0) return diffDay + ' day' + (diffDay > 1 ? 's' : '') + ' ago';
        if (diffHr > 0) return diffHr + ' hour' + (diffHr > 1 ? 's' : '') + ' ago';
        if (diffMin > 0) return diffMin + ' min ago';
        return diffSec + ' sec ago';
      }

      // Initial load
      loadFileList();
    </script>

  </main>

</body>

</html>