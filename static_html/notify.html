<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>home service</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" />
    <link rel="stylesheet" href="https://milligram.io/styles/main.css" />
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #888;
            margin-top: 2em;
            transition: border-color 0.2s;
        }

        .drop-zone.dragover {
            border-color: #333;
            background: #f9f9f9;
            color: #333;
        }

        .drop-zone input {
            display: none;
        }

        #progressContainer {
            width: 100%;
            background: #eee;
            border-radius: 4px;
            margin: 1em 0;
            height: 18px;
            display: none;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: #9b4dca;
            border-radius: 4px;
            transition: width 0.2s;
        }

        .logout-btn {
            margin-bottom: 2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f4f4f4;
        }

        tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>

<body>
    <main class="wrapper">

        <section class="container" id="examples">
            <h1 class="title">home service</h1>

            <h4>
                <a href="/bookmarks">bookmarks</a> (<a href="/bookmarks/edit">#</a>) /
                <a href="/statistics">statistics</a> /
                <a href="notify">notify</a> /
                <a href="storage">storage</a>
            </h4>

            <form id="uploadForm" action="/api/upload" method="post" enctype="multipart/form-data">
                <div class="drop-zone" id="dropZone">
                    <p>Drag &amp; drop files here to upload<br>or <label style="color:#9b4dca;cursor:pointer;">
                            <input type="file" id="fileInput" name="files" multiple />browse</label></p>
                    <div id="progressContainer">
                        <div id="progressBar"></div>
                    </div>
                    <div id="uploadStatus"></div>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                        <label for="targetEmail">Target email address</label>
                        <select id="targetEmail" name="targetEmail">
                            <option value="private">Private</option>
                            <option value="work">Work</option>
                        </select>
                        <label for="subject">Subject</label>
                        <input type="text" id="subject" name="subject" placeholder="Enter subject..." />
                        <label for="message">Description</label>
                        <textarea id="message" name="message" placeholder="Enter message..." rows="4"
                            style="resize:vertical;"></textarea>
                    </div>
                </div>
                <button type="submit" class="button" style="margin-top:12px;">Send</button>
            </form>
        </section>

        <script>
            // Drag & Drop Upload Logic
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');

            function uploadFiles(files) {
                if (!files.length) return;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                uploadStatus.textContent = '';
                const formData = new FormData();
                for (const file of files) {
                    formData.append('files', file);
                }

                // enforce only uploading files
                formData.set('onlyUpload', 'true');

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/upload', true);

                xhr.upload.onprogress = function (e) {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressBar.style.width = percent + '%';
                    }
                };
                xhr.onload = function () {
                    progressContainer.style.display = 'none';
                    if (xhr.status === 200 || xhr.status === 201) {
                        uploadStatus.textContent = 'Notify sent successful!';
                        uploadStatus.style.color = 'green';
                        loadFileTable();
                    } else {
                        uploadStatus.textContent = 'Notify failed.';
                        uploadStatus.style.color = 'red';
                    }
                };
                xhr.onerror = function () {
                    progressContainer.style.display = 'none';
                    uploadStatus.textContent = 'Notify failed.';
                    uploadStatus.style.color = 'red';
                };
                xhr.send(formData);
            }

            // Drag & Drop: Only update the file input, do NOT upload automatically
            dropZone.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', function (e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files && e.dataTransfer.files.length) {
                    // Set the dropped files to the file input (simulate selection)
                    fileInput.files = e.dataTransfer.files;
                    // Optionally, show a message or file list here
                    uploadStatus.textContent = `${fileInput.files.length} file(s) ready to upload.`;
                    uploadStatus.style.color = '#333';
                }
            });

            // The form will be submitted only when the user clicks the Send button
            document.getElementById('uploadForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                // Debug: log all keys and values
                // for (let pair of formData.entries()) {
                //     console.log(pair[0], pair[1]);
                // }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/upload', true);

                xhr.onload = function () {
                    if (xhr.status === 200 || xhr.status === 201) {
                        uploadStatus.textContent = 'Notify successful!';
                        uploadStatus.style.color = 'green';
                    } else {
                        uploadStatus.textContent = 'Notify failed.';
                        uploadStatus.style.color = 'red';
                    }
                };
                xhr.onerror = function () {
                    uploadStatus.textContent = 'Notify failed.';
                    uploadStatus.style.color = 'red';
                };
                xhr.send(formData);
            });
        </script>
    </main>

</body>

</html>